version: '3.8'

services:
  # ==============================================================================
  # Digital Actors Web Application (Production)
  # ==============================================================================
  digital-actors:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: digital-actors
    ports:
      - "8888:8888"
    environment:
      # Python Configuration
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1

      # Server Configuration
      - PORT=8888

      # API Keys (loaded from .env file)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}

      # ElevenLabs Configuration
      - ELEVENLABS_VOICE_ELIZA=${ELEVENLABS_VOICE_ELIZA:-}
      - ELEVENLABS_VOICE_ENGINEER=${ELEVENLABS_VOICE_ENGINEER:-}
      - ELEVENLABS_VOICE_WIZARD=${ELEVENLABS_VOICE_WIZARD:-}
      - ELEVENLABS_VOICE_DETECTIVE=${ELEVENLABS_VOICE_DETECTIVE:-}
      - ELEVENLABS_MODEL=${ELEVENLABS_MODEL:-eleven_turbo_v2_5}
      - ELEVENLABS_PRESERVE_AUDIO_TAGS=${ELEVENLABS_PRESERVE_AUDIO_TAGS:-true}

      # Sentry Configuration (optional)
      - SENTRY_DSN=${SENTRY_DSN:-}
      - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT:-production}
      - SENTRY_TRACES_SAMPLE_RATE=${SENTRY_TRACES_SAMPLE_RATE:-0.1}

      # Logging Configuration
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}

    volumes:
      # Persistent data volumes
      - ./data:/app/data
      - ./voicecache:/app/voicecache
      - ./audio:/app/audio

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - digital-actors-network

  # ==============================================================================
  # Development Service (with hot-reload and source code mounting)
  # ==============================================================================
  # Usage: docker-compose --profile dev up
  digital-actors-dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: digital-actors-dev
    ports:
      - "8888:8888"
    environment:
      # Python Configuration
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1

      # Server Configuration
      - PORT=8888

      # API Keys (loaded from .env file)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}

      # ElevenLabs Configuration
      - ELEVENLABS_VOICE_ELIZA=${ELEVENLABS_VOICE_ELIZA:-}
      - ELEVENLABS_VOICE_ENGINEER=${ELEVENLABS_VOICE_ENGINEER:-}
      - ELEVENLABS_VOICE_WIZARD=${ELEVENLABS_VOICE_WIZARD:-}
      - ELEVENLABS_VOICE_DETECTIVE=${ELEVENLABS_VOICE_DETECTIVE:-}
      - ELEVENLABS_MODEL=${ELEVENLABS_MODEL:-eleven_turbo_v2_5}
      - ELEVENLABS_PRESERVE_AUDIO_TAGS=${ELEVENLABS_PRESERVE_AUDIO_TAGS:-true}

      # Sentry Configuration (optional)
      - SENTRY_DSN=${SENTRY_DSN:-}
      - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT:-development}
      - SENTRY_TRACES_SAMPLE_RATE=${SENTRY_TRACES_SAMPLE_RATE:-0.1}

      # Logging Configuration (more verbose for dev)
      - LOG_LEVEL=${LOG_LEVEL:-DEBUG}
      - LOG_FORMAT=${LOG_FORMAT:-console}

    volumes:
      # Mount source code for hot-reload (excludes cache)
      - .:/app:cached
      - /app/.venv
      - /app/__pycache__
      - /app/.pytest_cache
      - /app/htmlcov

      # Persistent data volumes
      - ./data:/app/data
      - ./voicecache:/app/voicecache
      - ./audio:/app/audio

    command: python web_server.py
    restart: unless-stopped

    networks:
      - digital-actors-network

    profiles:
      - dev

  # ==============================================================================
  # Prometheus (Metrics Collection)
  # ==============================================================================
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: digital-actors-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    restart: unless-stopped
    networks:
      - digital-actors-network
    depends_on:
      - digital-actors

  # ==============================================================================
  # Grafana (Metrics Visualization)
  # ==============================================================================
  grafana:
    image: grafana/grafana:10.2.2
    container_name: digital-actors-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana-dashboard.json:/etc/grafana/provisioning/dashboards/digital-actors.json:ro
    restart: unless-stopped
    networks:
      - digital-actors-network
    depends_on:
      - prometheus

networks:
  digital-actors-network:
    driver: bridge

volumes:
  prometheus-data:
  grafana-data:
